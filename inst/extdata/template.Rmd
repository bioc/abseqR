---
title: "AbSeq"
header-evals:
  - \usepackage{comment}
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
params:
    # img dimensions
    width: 8
    height: 5
    # larger sizes (if needed)
    widthL: 12
    heightL: 7.5
    # ggplotly?
    interactive: TRUE
    # eval D-gene abundance related plots? - light chain might not want this
    inclD: TRUE
    # sample name
    name: "PLACEHOLDER SAMPLE NAME"
    # single sample?
    single: FALSE
    # root output directory
    rootDir: "/newhome/jiahong/sandbox/immulator_out/output_results/report/PCR1_ACGT_L001_crossed_vs_PCR2_ACGT_L001_crossed"
    hasAnnot: TRUE
    hasAbun: TRUE
    hasProd: TRUE
    hasDiv: TRUE
---

<style type="text/css">
.chart-title {  /* increase chart title font size */
   font-size: 24px;
}
</style>

```{r setup, include=FALSE}
# Buidling rmd using loops: https://github.com/rstudio/flexdashboard/issues/80

library(flexdashboard)
library(plotly)
library(png)
library(grid)
library(gridExtra)

.getFile <- function(path, pattern, .stop = F, .callback = NULL) {
    flist <- list.files(path = path, pattern = pattern, full.names = T)
    n <- length(flist)
    if (n != 1 && is.null(.callback)) {
        if (.stop) {
            stop(paste("Expected to find one file, but found", n, "from",
                       paste(flist, collapse = ", "), "instead"))
        } else {
            return(NA)
        }
    } else if (!is.null(.callback)) {
        flist <- flist[lapply(flist, .callback) == T]
    }
    return(flist[[1]])
}

.compositionNoGene <- function(x) {
    return(length(grep("-", x, fixed = T)) == 0)
}
```

<!-- 
Page 1 is a overview of the sample analysis
-->


`r if(!params$hasAnnot) {"\\begin{comment}"}`


Summary {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------

### Sequence lengths without outlier removal

```{r, eval=params$hasAnnot, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "annot"),
                  pattern = ".*_all_clones_len_dist\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

Row
-----------------------------------------------------------------------

### Sequence lengths __with__ outlier removal

```{r, eval=params$hasAnnot, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "annot"),
                  pattern = ".*_all_clones_len_dist_no_outliers\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```


`r if(!params$hasAnnot) {"\\end{comment}"}`


<!-- Page 2 is abundance analysis -->


`r if(!params$hasAbun) {"\\begin{comment}"}`


Abundance {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------

### V family 

```{r, eval=params$hasAbun, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igv_dist_family_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

### V gene

```{r, eval=params$hasAbun, fig.width=params$height, fig.height=params$width}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igv_dist_gene_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    # TODO: ggplotly is buggy with horizontal plot in tabsets
    if (params$interactive) {
        plot
        #ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Only the top 15 from each sample are shown


`r if(!params$inclD) {"\\begin{comment}"}`


Row
-----------------------------------------------------------------------

### D family

```{r, eval=(params$inclD && params$hasAbun), fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igd_dist_family_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

### D gene

```{r, eval=(params$inclD && params$hasAbun), fig.width=params$height, fig.height=params$width}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igd_dist_gene_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    # TODO: ggplotly is buggy with horizontal plot in tabsets
    if (params$interactive) {
        plot
        #ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
    
```

> Only the top 15 from each sample are shown


`r if(!params$inclD) {"\\end{comment}"}`



Row
-----------------------------------------------------------------------

### J family

```{r, eval=params$hasAbun, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igj_dist_family_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

### J variant

```{r, eval=params$hasAbun, fig.width=params$height, fig.height=params$width}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*igj_dist_variant_level\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    # TODO: ggplotly is buggy with horizontal plot in tabsets
    if (params$interactive) {
        plot
        #ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Only the top 15 from each sample are shown



`r if(!params$single) {"\\begin{comment}"}`



Row
-----------------------------------------------------------------------

### V-J association

```{r, eval=(params$single && params$hasAbun), fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"), pattern = ".*_vjassoc\\.png")
if (!is.na(fname)) {
    img <- readPNG(fname)
    grid.raster(img)
} else {
    cat("404!")
}
```

> Plot associations between V genes and J genes on the family level




Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
```{r, echo = FALSE, eval = params$single}
alignQual <- list("Bitscore vs Alignment Length" = "bitscore",
               "Gaps vs Alignment Length" = "gaps",
               "Identity vs Alignment Length" = "identity",
               "Mismatches vs Alignment Length" = "mismatches",
               "Subject Start vs Query Start" = "start")
alignmentQuality <- lapply(seq_along(alignQual), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s\n", names(alignQual)[i]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r align_qual_chunk_%d, eval=params$hasAbun, fig.width=params$width, fig.height=params$height}", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(path = file.path(params$rootDir, "abundance"), pattern = ".*_igv_align_quality_%s_hm\\\\.png")', alignQual[[i]]))
    line4 <- knitr::knit_expand(text = '\nif(!is.na(fname)) { img <- readPNG(fname); grid.raster(img) } else { cat("404!") }')
    line5 <- knitr::knit_expand(text = "\n```\n")
    paste(line1, line2, line3, line4, line5, collapse = "\n")
})
```

`r if (params$single) { paste(knitr::knit(text = paste(alignmentQuality, collapse = "\n"))) }`


`r if(!params$single) {"\\end{comment}"}`


Row
-----------------------------------------------------------------------

### Indels (Gaps)
```{r, eval=params$hasAbun, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*_igv_gaps_dist\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Plot of insertions and deletions found within the __V gene__

### Mismatches
```{r, eval=params$hasAbun, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "abundance"),
                  pattern = ".*_igv_mismatches_dist\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Plot of nucleotide base mismatches found within the __V gene__


`r if(!params$hasAbun) {"\\end{comment}"}`




`r if(!params$hasProd) {"\\begin{comment}"}`


Productivity {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------

### Productivity summary

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_productivity\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        # TODO: buggy facet plot
        plot
        # ggplotly(plot)
    } else {
        plot
    }
} else {
    ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5,
                                                                y = 5, label =
                                                                    "404!")
}
```

> Productivity distribution of sample based on stop codons and frameshifts

### Frameshift distribution

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_vjframe_dist\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5,
                                                                y = 5, label =
                                                                    "404!")
}
```

> Distribution of in-frame and out-of-frame sequences

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
<!--  Example of how it should look like after knitting
### CDR1
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_cdr1_mismatches_dist\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        mismatch <- ggplotly(plot + labs(title = "Mismatches, gaps and gaps in out-of-frame sequences in CDR1"))
    } else {
        mismatch <- plot
    }
} else {
    df <- data.frame()      # give user empty graph
    mismatch  <- ggplot(df), + geom_point() + xlim(0, 10) + ylim(0, 100)
}

fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_cdr1_gaps_dist\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        gaps <- ggplotly(plot + labs(title = ""))
    } else {
        gaps <- plot
    }
} else {
    df <- data.frame()      # give user empty graph
    gaps <- ggplot(df), + geom_point() + xlim(0, 10) + ylim(0, 100)
}

fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_cdr1_gaps_dist_out_of_frame\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        gapsOut <- ggplotly(plot + labs(title = ""))
    } else {
        gapsOut <- plot
    }
} else {
    df <- data.frame()      # give user empty graph
    gapsOut  <- ggplot(df), + geom_point() + xlim(0, 10) + ylim(0, 100)
}

if (params$interactive) {
    subplot(mismatch, gaps, gapsOut, titleX = TRUE, titleY = TRUE)
} else {
    grid.arrange(mismatch, gaps, gapsOut, nrow = 1)
}
> Mismatches, gaps, gaps (in out-of-frame sequences) distribution in %s region\n
-->

<!-- TODO: fix legend && beware of missing samples when doing so -->
```{r echo = FALSE, eval = TRUE}
titles <- c("FR1", "CDR1", "FR2", "CDR2", "FR3", "CDR3")
frcdrMisGaps <- lapply(seq_along(titles), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s\n", titles[i]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r frcdr_gap_mis_chunk_%d, eval=params$hasProd, fig.width=params$width*3, fig.height=params$height}", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "productivity"), pattern = ".*_%s_mismatches_dist\\\\.Rdata")', tolower(titles[i])))
    line4 <- knitr::knit_expand(text = sprintf('\nif (!is.na(fname)) { load(fname); if (params$interactive) { mismatch <- ggplotly(plot + labs(title = "Mismatches, gaps and gaps in out-of-frame sequences in %s")) } else { mismatch <- plot } } else { df <- data.frame(); mismatch <- ggplot(df) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }', titles[i]))
    line5 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "productivity"), pattern = ".*_%s_gaps_dist\\\\.Rdata")', tolower(titles[i])))
    line6 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { load(fname); if (params$interactive) { gaps <- ggplotly(plot + labs(title = "")) } else { gaps <- plot } } else { df <- data.frame(); gaps <- ggplot(df) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")}')
    line7 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "productivity"), pattern = ".*_%s_gaps_dist_out_of_frame\\\\.Rdata")', tolower(titles[i])))
    line8 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { load(fname); if (params$interactive) { gapsOut <- ggplotly(plot + labs(title = "")) } else { gapsOut <- plot } } else { df <- data.frame(); gapsOut <- ggplot(df) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }')
    line9 <- knitr::knit_expand(text = "\nif (params$interactive) { subplot(mismatch, gaps, gapsOut, titleX = T, titleY = T) } else { grid.arrange(mismatch, gaps, gapsOut, nrow = 1)}")
    line10 <- knitr::knit_expand(text = "\n```\n")
    line11 <- knitr::knit_expand(text = sprintf("\n> Mismatches, gaps and gaps (in out-of-frame sequences) distribution in %s region\n", titles[i]))
    paste(line1, line2, line3, line4, line5, line6, line7, line8, line9, line10,
          line11, collapse = "\n")
})
```

`r paste(knitr::knit(text = paste(frcdrMisGaps, collapse = "\n")))`

<!-- Example of this knitr output:
### IGV
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_igv_mismatches_dist\\.Rdata")
# take the titles away if it's interactive because subplots will only use the first
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        mismatch <- ggplotly(plot + labs(title = "Mismatches and gaps in IGV"))
    } else {
        mismatch <- plot
    }
} else {
    df <- data.frame()      # give user empty graph
    mismatch <- ggplot(df), + geom_point() + xlim(0, 10) + ylim(0, 100)
}

fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_igv_gaps_dist\\.Rdata")
if (is.na(fname)) {}
    load(fname)
    if (params$interactive) {
        gaps <- ggplotly(plot + labs(title = ""))
    } else {
        gaps <- plot
    }
} else {
    df <- data.frame()      # give user empty graph
    gaps <- ggplot(df), + geom_point() + xlim(0, 10) + ylim(0, 100)
}

if (params$interactive) {
    subplot(mismatch, gaps, titleX = TRUE, titleY = TRUE)
} else {
    grid.arrange(mismatch, gaps, nrow = 1)
}
> Mismatches and gaps distribution in V gene
-->

<!-- TODO: fix legend && beware of missing samples when doing so -->
```{r echo = FALSE, eval = TRUE}
if (params$inclD) {
    titles <- c("IGV", "IGD", "IGJ")
} else {
    titles <- c("IGV", "IGJ")
}
vdjMisGaps <- lapply(seq_along(titles), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s\n", titles[i]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r vdj_gap_mis_chunk_%d, eval=params$hasProd, fig.width=params$width*3, fig.height=params$height}", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "productivity"), pattern = ".*_%s_mismatches_dist\\\\.Rdata")', tolower(titles[i])))
    line4 <- knitr::knit_expand(text = sprintf('\nif (!is.na(fname)) { load(fname); if (params$interactive) { mismatch <- ggplotly(plot + labs(title = "Mismatches and gaps in %s")) } else { mismatch <- plot } } else { df <- data.frame(); mismatch <- ggplot(df) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }', titles[i]))
    line5 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "productivity"), pattern = ".*_%s_gaps_dist\\\\.Rdata")', tolower(titles[i])))
    line6 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { load(fname); if (params$interactive) { gaps <- ggplotly(plot + labs(title = "")) } else { gaps <- plot } } else { df <- data.frame(); gaps <- ggplot(df) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }')
    line7 <- knitr::knit_expand(text = "\nif (params$interactive) { subplot(mismatch, gaps, titleX = T, titleY = T) } else { grid.arrange(mismatch, gaps, nrow = 1)}")
    line8 <- knitr::knit_expand(text = "\n```\n")
    line9 <- knitr::knit_expand(text = sprintf("\n> Mismatchesa and gaps distribution in %s\n", titles[i]))
    paste(line1, line2, line3, line4, line5, line6, line7, line8, line9, collapse = "\n")
})
```

`r paste(knitr::knit(text = paste(vdjMisGaps, collapse = "\n")))`


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### IGV productive distribution

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_igv_dist_productive\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Distribution of productive sequences from IGV family

### IGV inframe, unproductive distribution

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_igv_dist_inframe_unproductive\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Distribution of in-frame but unproductive sequences from IGV family

### IGV out-of-frame distribution

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_igv_dist_out_of_frame\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Distribution of out-of-frame sequences from IGV family


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Inframe

```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_stopcodon_region_inframe\\.Rdata", .stop = F)
if (is.na(fname)) {
    cat(paste("Plot is not available for this sample, probably because there's",
                "no such distribution present in this sample"))
} else {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
}

```

> Distribution of stop codons in CDR/FR regions from in-frame sequences

### Out-of-frame
```{r, eval=params$hasProd, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "productivity"),
                  pattern = ".*_stopcodon_region_outframe\\.Rdata", .stop = F)
if (is.na(fname)) {
    cat(paste("Plot is not available for this sample, probably because there's",
                "no such distribution present in this sample"))
} else {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
}
```

> Distribution of stop codons in CDR/FR regions from out-of-frame sequences



`r if(!params$hasProd) {"\\end{comment}"}`



`r if(!params$hasDiv) {"\\begin{comment}"}`



<!-- TODO: currently, assumes that all 3 rarefaction, duplication, and recapture
are present because of the ggplotly legend hack -->

Diversity {data-orientation=rows}
=======================================================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### CDR-V

```{r, eval=params$hasDiv, fig.width=params$width*3, fig.height=params$height}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_v_duplication\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    dup <- plot + labs(title = "Sequence duplication level, rarefaction, and recapture")
} else {
    dup <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_v_rarefaction\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    rare <- plot + labs(title = "")
} else {
    rare <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_v_recapture\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    recap <- plot + labs(title = "")
} else {
    recap <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

if (params$interactive) {
    dup <- hide_legend(dup)
    rare <- hide_legend(rare)
    p <- subplot(hide_legend(dup), hide_legend(rare), recap, titleX = T, titleY = T)
    .p <- plotly_build(p)
    for (i in seq_along(.p$x$data)) {
        if (length(grep(",\\d+(,NA)?\\)$", .p$x$data[[i]]$name))) {
            .p$x$data[[i]]$showlegend <- FALSE
        }
    }
    .p
} else {
    grid.arrange(dup, rare, recap, nrow = 1)
}
```

> Duplication level, rarefaction and recapture plots for CDR (regions) and
(V)ariable domain


### CDR

```{r, eval=params$hasDiv, fig.width=params$width*3, fig.height=params$height}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_duplication\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    dup <- plot + labs(title = "Sequence duplication level, rarefaction, and recapture")
} else {
    dup <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_rarefaction\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    rare <- plot + labs(title = "")
} else {
    rare <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_cdr_recapture\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    recap <- plot + labs(title = "")
} else {
    recap <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

if (params$interactive) {
    dup <- hide_legend(dup)
    rare <- hide_legend(rare)
    p <- subplot(hide_legend(dup), hide_legend(rare), recap, titleX = T, titleY = T)
    .p <- plotly_build(p)
    for (i in seq_along(.p$x$data)) {
        if (length(grep(",\\d+(,NA)?\\)$", .p$x$data[[i]]$name))) {
            .p$x$data[[i]]$showlegend <- FALSE
        }
    }
    .p
} else {
    grid.arrange(dup, rare, recap, nrow = 1)
}
```

> Duplication level, rarefaction and recapture plots for CDR (regions)


### FR

```{r, eval=params$hasDiv, fig.width=params$width*3, fig.height=params$height}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_fr_duplication\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    dup <- plot + labs(title = "Sequence duplication level, rarefaction, and recapture")
} else {
    dup <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_fr_rarefaction\\.Rdata")

if (!is.na(fname)) {
    load(fname)
    rare <- plot + labs(title = "")
} else {
    rare <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity"),
                  pattern = ".*_fr_recapture\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    recap <- plot + labs(title = "")
} else {
    recap <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}

if (params$interactive) {
    dup <- hide_legend(dup)
    rare <- hide_legend(rare)
    p <- subplot(hide_legend(dup), hide_legend(rare), recap, titleX = T, titleY = T)
    .p <- plotly_build(p)
    for (i in seq_along(.p$x$data)) {
        if (length(grep(",\\d+(,NA)?\\)$", .p$x$data[[i]]$name))) {
            .p$x$data[[i]]$showlegend <- FALSE
        }
    }
    .p
} else {
    grid.arrange(dup, rare, recap, nrow = 1)
}
```

> Duplication level, rarefaction and recapture plots for FR (regions)



Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

<!-- EXAMPLE:
### CDR1
```{r, eval=params$hasDiv, fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "diversity", "spectratypes"), pattern = ".*_cdr1_spectratype\\.Rdata")
if (!is.na(fname)) { load(fname); if (params$interactive) { ggplotly(plot); } else { plot; } } else { cat("404!"); }
```

> Amino acid lengths distribution for CDR1 region
-->

```{r, echo=FALSE, eval=params$hasDiv}
regions <-
    c(
    "FR1" = "_fr1_spectratype",
    "CDR1" = "_cdr1_spectratype",
    "FR2" = "_fr2_spectratype",
    "CDR2" = "_cdr2_spectratype",
    "FR3" = "_fr3_spectratype",
    "CDR3" = "_cdr3_spectratype",
    "CDR3 without outliers" = "_cdr3_spectratype_no_outliers",
    "FR4" = "_fr4_spectratype",
    "V domain" = "_v_spectratype"
    )
specOut <- lapply(seq_along(regions), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s\n", names(regions)[[i]]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r spec_out_%d, eval=params$hasDiv, fig.width=params$width, fig.height=params$height}\n", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(path = file.path(params$rootDir, "diversity", "spectratypes"), pattern = ".*%s\\\\.Rdata")\n', regions[[i]]))
    line4 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { load(fname); if (params$interactive) { ggplotly(plot); } else { plot; } } else { cat("404!"); }')
    line5 <- knitr::knit_expand(text = "\n```\n")
    line6 <- knitr::knit_expand(text = sprintf("\n> Amino acid length distribution for %s region\n", names(regions)[[i]]))
    paste(line1, line2, line3, line4, line5, line6, collapse = "\n")
})
```

`r if (params$hasDiv) { paste(knitr::knit(text = paste(specOut, collapse = '\n'))) }`


`r if(params$single) {"\\begin{comment}"}`


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r, echo=FALSE, eval=(!params$single && params$hasDiv)}
files <- list.files(path = file.path(params$rootDir, "diversity"),
                    pattern = ".*_clone_scatter\\.Rdata",
                    full.names = T)
scatterOut <- lapply(seq_along(files), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### sample %d vs sample %d\n", i, i + 1))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r scatter_out_%d, eval=(params$hasDiv && !params$single), fig.width=params$width, fig.height=params$height}\n", i))
    line3 <- knitr::knit_expand(text = sprintf('fname <- "%s"; load(fname); if (params$interactive) { ggplotly(plot); } else { plot; }', files[[i]]))
    line4 <- knitr::knit_expand(text = "\n```\n")
    line5 <- knitr::knit_expand(text = "\n> Clonotype counts from 2 samples\n")
    paste(line1, line2, line3, line4, line5, collapse = "\n")
})

```

`r if(!params$single && params$hasDiv) { paste(knitr::knit(text = paste(scatterOut, collapse = '\n'))) }`


Row
-----------------------------------------------------------------------

### Distribution of top 10 (colour coded) clonotypes from each sample

```{r, eval=(params$hasDiv && !params$single), fig.width=params$widthL, fig.height=params$heightL}
fname <- .getFile(path = file.path(params$rootDir, "diversity"), pattern = ".*_top10Clonotypes\\.Rdata")
if (!is.na(fname)) {
    load(fname)
    if (params$interactive) {
        ggplotly(plot)
    } else {
        plot
    }
} else {
    cat("404!")
}
```

> Clonotype distributions are scaled to top 10


### Number of shared (and exclusive) clonotypes among samples

```{r, eval=(params$hasDiv && !params$single), fig.width=params$width, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "diversity"), pattern = ".*_cdr3_clonotypeIntersection\\.png")
if (!is.na(fname)) {
    img <- readPNG(fname)
    grid.raster(img)
} else {
    ggplot(data.frame()) +
        xlim(0, 10) +
        ylim(0, 10) +
        annotate("text", x = 5, y = 5, label = "Can't find clonotype venn diagram, you probably have > 5 samples")
}
```

> Counts show number of clonotypes


`r if(params$single) {"\\end{comment}"}`



`r if(!params$single) {"\\begin{comment}"}`


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
<!-- composition logos EXAMPLE:

### CDR1 (unscaled, scaled)
{r, eval=(params$hasDiv && params$single), fig.width=params$width*2, fig.height=params$height}
# dont grep the IGV-X composition logos
fname <- .getFile(path = file.path(params$rootDir, "diversity", "composition_logos", "CDR1"), pattern = ".*_cumulative_logo\\.Rdata", .callback = function(x) {
    length(grep("-", x, fixed = T)) == 0
})

removeLegend <- FALSE
if (!is.na(fname)) {
    load(fname)
    unscaled <- plot
} else {
    unscaled <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "404!")
}

fname <- .getFile(path = file.path(params$rootDir, "diversity", "composition_logos", "CDR1"), pattern = ".*_cumulative_logo_scaled\\.Rdata", .callback = function(x) {
    length(grep("-", x, fixed = T)) == 0
})

if (!is.na(fname)) {
    load(fname)
    scaled <- plot
    removeLegend <- TRUE
} else {
    scaled <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "404!")
}

if (params$interactive) {
    if (removeLegend) {
        unscaled <- hide_legend(ggplotly(unscaled))
    }
    subplot(unscaled, scaled)
    .p <- plotly_build(p)
    for (i in seq_along(.p$x$data)) {
        if (length(grep("x\\d+", .p$x$data[[i]]$xaxis))) {
            .p$x$data[[i]]$showlegend <- FALSE
        }
    }
    .p
} else {
    grid.arrange(unscaled, scaled, nrow = 1)
}


> Amino acid composition logos - unscaled (sum to 1 in each individual position) and scaled (to the max number of sequences in a given position).
-->

```{r, echo = FALSE, eval = (params$single && params$hasDiv)}
regions = c("FR1", "CDR1", "FR2", "CDR2", "FR3", "CDR3", "FR4")
compOut <- lapply(seq_along(regions), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s\n", regions[i]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r comp_out_%d, eval=(params$hasDiv && params$single), fig.width=params$width*2, fig.height=params$height}\n", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "diversity", "composition_logos", "%s"), pattern = ".*_cumulative_logo\\\\.Rdata", .callback = .compositionNoGene)', regions[i]))
    line4 <- knitr::knit_expand(text = '\nremoveLegend <- FALSE; if (!is.na(fname)) { load(fname); unscaled <- plot; } else { unscaled <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "404!"); }')
    line5 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(file.path(params$rootDir, "diversity", "composition_logos", "%s"), pattern = ".*_cumulative_logo_scaled\\\\.Rdata", .callback = .compositionNoGene)', regions[i]))
    line6 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { load(fname); scaled <- plot; removeLegend <- TRUE; } else { scaled <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "404!"); }')
    line7 <- knitr::knit_expand(text = '\nif (params$interactive) { if (removeLegend) { unscaled <- hide_legend(ggplotly(unscaled)) }; p <- subplot(unscaled, scaled); .p <- plotly_build(p); for (i in seq_along(.p$x$data)) { if (length(grep("x\\\\d+", .p$x$data[[i]]$xaxis))) { .p$x$data[[i]]$showlegend <- FALSE } }; .p; } else { grid.arrange(unscaled, scaled, nrow = 1) }')
    line8 <- knitr::knit_expand(text = "\n```\n")
    line9 <- knitr::knit_expand(text = sprintf("\n> Amino acid composition logos in %s - unscaled (sum to 1 in each individual position) and scaled (to the max number of sequences in a given position).\n", regions[i]))
    paste(line1, line2, line3, line4, line5, line6, line7, line8, line9, collapse = "\n")
})
```

`r if (params$single && params$hasDiv) { paste(knitr::knit(text = paste(compOut, collapse = '\n'))) }`



Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
<!-- Motifs EXAMPLE:
### CDR1 Motifs (aligned, unaligned)

```{r, eval=(params$hasDiv && params$single), fig.width=params$width*2, fig.height=params$height}
fname <- .getFile(path = file.path(params$rootDir, "diversity", "motifs"), pattern = ".*cdr1_motif_aligned_logo\\.png")
if (!is.na(fname)) {
    imgAl <- rasterGrob(as.raster(readPNG(fname)), interpolate = FALSE)
} else {
    imgAl <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}
fname <- .getFile(path = file.path(params$rootDir, "diversity", "motifs"), pattern = ".*cdr1_motif_logo\\.png")
if (!is.na(fname)) {
    img <- rasterGrob(as.raster(readPNG(fname)), interpolate = FALSE)
} else {
    img <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable")
}
grid.arrange(imgAl, img, nrow = 1)
```
-->

```{r, echo = FALSE, eval = (params$hasDiv && params$single)}
regions = c("FR1", "CDR1", "FR2", "CDR2", "FR3", "CDR3", "FR4")
motifOut <- lapply(seq_along(regions), function(i) {
    line1 <- knitr::knit_expand(text = sprintf("### %s (aligned, unaligned)\n", regions[i]))
    line2 <- knitr::knit_expand(text = sprintf("\n```{r motif_out_%d, eval=(params$hasDiv && params$single), fig.width=params$width*2, fig.height=params$height}", i))
    line3 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(path = file.path(params$rootDir, "diversity", "motifs"), pattern = ".*%s_motif_aligned_logo\\\\.png")', tolower(regions[i])))
    line4 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { imgAl <- rasterGrob(as.raster(readPNG(fname)), interpolate = FALSE) } else { imgAl <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }')
    line5 <- knitr::knit_expand(text = sprintf('\nfname <- .getFile(path = file.path(params$rootDir, "diversity", "motifs"), pattern = ".*%s_motif_logo\\\\.png")', tolower(regions[i])))
    line6 <- knitr::knit_expand(text = '\nif (!is.na(fname)) { img <- rasterGrob(as.raster(readPNG(fname)), interpolate = FALSE) } else { img <- ggplot(data.frame()) + xlim(0, 10) + ylim(0, 10) + annotate("text", x = 5, y = 5, label = "Plot unavailable") }')
    line7 <- knitr::knit_expand(text = "\ngrid.arrange(imgAl, img, nrow = 1)")
    line8 <- knitr::knit_expand(text = "\n```\n")
    line9 <- knitr::knit_expand(text = sprintf("\n> (Left) %s aligned using clustal-omega (Right) unaligned motif discovery\n", regions[i]))
    paste(line1, line2, line3, line4, line5, line6, line7, line8, line9, collapse = "\n")
})
```

`r if (params$single && params$hasDiv) { paste(knitr::knit(text = paste(motifOut, collapse = '\n'))) }`




`r if(!params$single) {"\\end{comment}"}`
`r if(!params$hasDiv) {"\\end{comment}"}`

<!--
=======================================================================
-----------------------------------------------------------------------
-->




